---
title: "R Notebook"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(caret)
library(randomForest)
library(rebus)
library(mice)
library(glmnet)
library(miceadds)
library(lavaan)
```


```{r cars}
cas93<-readRDS("cas93.rds")
cas93 %>% mutate_at(vars(starts_with("B1_")),funs(factor)) %>% select(starts_with("B1_")) %>% count(B1_E)
```

We first look at missing data in section C:
\begin{enumerate}
  \item If the student hasn't had >5 drinks in a row for the past two weeks, they skip C2 and C3
  \item C6: If the student is alcohol abstinent, then they skip C7-C21. If the student hasn't drank in the past year, they skip C7-C18. If the student hasn't drank in the past month, they skip C7-C11.
  \item C11: Students skip this question if they are 21 years or older
  \item C22: Students skip this question if they have not had alcohol within the past year.
\end{enumerate}


```{r}
#all columns to character columns
cas93_C<-cas93[,grepl("^C[0-9]",colnames(cas93))]

abs<-"C[7-9]|C1[0-9]|C2[0-1]"
year<-"C[7-9]|C1[0-8]"
month<-"C[7-9]|C1[0-1]"

cas93_filled<-cas93_C %>% 
  mutate_at(vars( starts_with("C2_") ), 
          list( ~replace_na(.,0) ))  %>%
  mutate_at(vars( starts_with("C3_") ), 
          list( ~replace_na(.,0) ))

#imputing infrequent drinking for skipped questions C7-C21
abs_imp<-cas93_filled[,grep(abs,colnames(cas93_filled))]
abs_imp[rowSums(is.na(abs_imp))== ncol(abs_imp),]<-0

year_imp<-abs_imp[,grep(year,colnames(abs_imp))]
abs_imp[rowSums(is.na(year_imp))== ncol(year_imp),grep(year,colnames(abs_imp))]<-0

month_imp<-abs_imp[,grep(month,colnames(year_imp))]
abs_imp[rowSums(is.na(month_imp)) == ncol(month_imp),grep(month,colnames(year_imp))]<-0

#imputing older students for C11; still need to cross check with age group variable

q_c11<-abs_imp %>% select(starts_with("C11_"))
abs_imp[rowSums(is.na(q_c11)) == ncol(q_c11),grep("C11_",colnames(abs_imp))]<-0

#imputing students who didn't drink in the last year for C22; might have to take this with a grain of salt

q_c22<-cas93_filled %>% select(starts_with("C22_"))
cas93_filled[rowSums(is.na(q_c22)) == ncol(q_c22),grep("C22_",colnames(cas93_filled))]<-0


#Up to C7, up from C7:C10, C11, C12:C21, C22, rest
cas93_filled<-cbind(cas93_filled[1:10],abs_imp[1:69],cas93_filled[80:93])

```

We impute the rest of the missing values with MICE:

```{r}
mice_data<-mice(cas93_filled,m=4)
MICEd_impute_C<-complete(mice_data,1)
write.mice.imputation(mi.res=mice_data, name="mice_C" )

# #original data frame with imputed C
# cas93_w_final_c<-cbind(cas93[,!grepl("^C[0-9]",colnames(cas93))],mic) %>%
#   select(-COLL_ID,-STUDY_ID,-A1)
# 
# cas93_survey_only<-cas93_w_final_c[,grep("^[A-Z][1-9]",colnames(cas93_w_final_c))] 
```


```{r C-G,eval=FALSE}

#all columns to character columns
cas93_C<-cas93[,grepl("^C[0-9]",colnames(cas93))] %>%
  cbind(cas93$AGEGROUP) %>%
  mutate_each(as.character())

abs<-"C[7-9]|C1[0-9]|C2[0-1]"
year<-"C[7-9]|C1[0-8]"
month<-"C[7-9]|C1[0-1]"

cas93_filled<-cas93_C %>% 
  mutate_at(vars( starts_with("C2_") ), 
          list( ~replace_na(.,"<5") ))  %>%
  mutate_at(vars( starts_with("C3_") ), 
          list( ~replace_na(.,"<5") ))

#imputing infrequent drinking for skipped questions C7-C21
abs_imp<-cas93_filled[,grep(abs,colnames(cas93_filled))]
abs_imp[rowSums(is.na(abs_imp))== ncol(abs_imp),]<-"abs"

year_imp<-abs_imp[,grep(year,colnames(abs_imp))]
abs_imp[rowSums(is.na(year_imp))== ncol(year_imp),grep(year,colnames(abs_imp))]<-">year"

month_imp<-abs_imp[,grep(month,colnames(year_imp))]
abs_imp[rowSums(is.na(month_imp)) == ncol(month_imp),grep(month,colnames(year_imp))]<-">month"

#imputing older students for C11; still need to cross check with age group variable

q_c11<-abs_imp %>% select(starts_with("C11_"))
abs_imp[rowSums(is.na(q_c11)) == ncol(q_c11),grep("C11_",colnames(abs_imp))]<-">21"

#imputing students who didn't drink in the last year for C22; might have to take this with a grain of salt

q_c22<-cas93_filled %>% select(starts_with("C22_"))
cas93_filled[rowSums(is.na(q_c22)) == ncol(q_c22),grep("C22_",colnames(cas93_filled))]<-">year"


#Up to C7, up from C7:C10, C11, C12:C21, C22, rest
cas93_filled<-cbind(cas93_filled[1:10],abs_imp[1:69],cas93_filled[80:93])

#original data frame with imputed C
cas93_w_final_c<-cbind(cas93[,!grepl("^C[0-9]",colnames(cas93))],cas93_filled)  %>%
  mutate_if(sapply(., is.character), as.factor) %>%
  mutate_if(sapply(., is.numeric), as.factor) %>%
  select(-COLL_ID,-STUDY_ID,-A1)

cas93_survey_only<-cas93_w_final_c[,grep("^[A-Z][1-9]",colnames(cas93_w_final_c))] 

```


We now look at section G: there doesn't seem to be any obvious pattern to the missingness.

```{r}
#all columns to character columns
cas93_G<-cas93[,grepl("G[0-9]",colnames(cas93))] 
```


```{r}
MICEd_impute_C<-readRDS("MICEd_cas93.rds")
# saveRDS(MICE_cas93_dataset
# multinom_fit<-glmnet(MICEd_impute_C %>% mutate_each(as.numeric) %>% select(-C8) %>% as.matrix(), MICEd_impute_C %>% mutate_each(as.numeric) %>% select(C8) %>% as.matrix(), family="multinomial")
```
```{r}
C_potential_qs<-MICEd_impute_C %>% select(grep("C10|C14|C16|C17|C21",colnames(MICEd_impute_C)))
G_potential_qs<-MICEd_impute_C %>% select(grep("G2|G3|G8|G11|G12",colnames(MICEd_impute_C)))

plot_cats<-function(filt,name_col,title) {
  C<-C_potential_qs %>% 
  select(grep(filt,colnames(.))) %>%
  pivot_longer(cols=everything(),names_to=name_col)
  var_name_to_plot<- name_col

ggplot(C,aes_string(x=name_col))+geom_bar()+
  facet_wrap(value~.,scales="free") +
  ggtitle(title) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
}

plot_cats("C16","reasons","Reasons for Drinking Faceted by Importance")
```
One means very important, 4 means not important. 
```{r}
plot_cats("C10","events","Event Types attended, Faceted by #Drinks")

```

```{r}
C14<-C_potential_qs %>% 
  select(grep("C14",colnames(.))) 
colnames(C14)<-"type_drink"

ggplot(C14,aes_string(x="type_drink"))+geom_bar()+
  ggtitle("Typical Type of Drink") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```
The order here is missing, beer, low-alc beer, wine cooler, wine, liquor, no usual drink. People tend to prefer beer, while a substantial portion prefer harder alcohol and cocktails.

```{r}
plot_cats("C17","conseqs","Consequences of Drinking Faceted by Frequency")
```

One indicates not at all, 3 means 2x or more. Hangovers are pretty common, as is missing a class. Quite a few people (around 2500) have had one experience where drinking caused them to do something they regretted. Forgetfullness, arguments, and unplanned sex are also not-insignificant consequences.

```{r}
C21<-C_potential_qs %>% 
  select(grep("C21",colnames(.))) 
colnames(C21)<-"change"

ggplot(C21,aes_string(x="change"))+geom_bar()+
  ggtitle("Change from Freshman Year") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```
One means never drank, 2: drinks a lot more, 3: drinks more, 4: drinks same, 5: drinks less, 6" drinks a lot less. More people drink less as college goes on.

```{r PCA-attempt}
A<-MICEd_impute_C %>%
  select(grep("^A[0-9]",colnames(.)))
A_PCA<-prcomp(A,center=TRUE,scale=TRUE)
A_PCA$x
```


Data for 1993

```{r G-prep}

MICEd_impute<-MICEd_impute_C %>% 
  mutate(ones=1) %>%
  pivot_wider(names_from=G3,values_from=ones, values_fill=list(ones=0),names_prefix = "G3_") %>%  #indicators for race
  mutate(ones=1) %>%
  pivot_wider(names_from=G4,values_from=ones, values_fill=list(ones=0),names_prefix = "G4_") %>%  #indicators for religion
  mutate(G14_NA=as.numeric(G14==5),G14_none=as.numeric(G14==6),G15_NA=as.numeric(G15==5),G15_none=as.numeric(G15==6)) %>% #indicators for don't know/NA, parental education
  mutate(G11_NA=as.numeric(G11==8),G11_none=as.numeric(G11==1),G12_NA=as.numeric(G12==8),G12_none=as.numeric(G12==1)) %>% #indicators for don't know/NA, parental drinking
  mutate(G13_none=as.numeric(G13==4)) #indicator for no family agreement about drinking


```
```{r living-sit}
MICEd_impute <- MICEd_impute %>%
  mutate(ones=1) %>%
  pivot_wider(names_from=A5,values_from=ones, values_fill=list(ones=0),names_prefix = "A5_") %>%  #indicators for housing type
  mutate(ones=1) %>%
  pivot_wider(names_from=A6,values_from=ones, values_fill=list(ones=0),names_prefix = "A6_")  #indicators for roommates
  
```

1993 UnMICEd data

```{r}
MICEd_impute<-cas93 %>% 
  mutate(ones=1) %>%
  pivot_wider(names_from=G3,values_from=ones, values_fill=list(ones=0),names_prefix = "G3_") %>%  #indicators for race
  mutate(ones=1) %>%
  pivot_wider(names_from=G4,values_from=ones, values_fill=list(ones=0),names_prefix = "G4_") %>%  #indicators for religion
  mutate(G14_NA=as.numeric(G14==5),G14_none=as.numeric(G14==6),G15_NA=as.numeric(G15==5),G15_none=as.numeric(G15==6)) %>% #indicators for don't know/NA, parental education
  mutate(G11_NA=as.numeric(G11==8),G11_none=as.numeric(G11==1),G12_NA=as.numeric(G12==8),G12_none=as.numeric(G12==1)) %>% #indicators for don't know/NA, parental drinking
  mutate(G13_none=as.numeric(G13==4)) %>% #indicator for no family agreement about drinking
  mutate(ones=1) %>%
  pivot_wider(names_from=A5,values_from=ones, values_fill=list(ones=0),names_prefix = "A5_") %>%  #indicators for housing type
  mutate(ones=1) %>%
  pivot_wider(names_from=A6,values_from=ones, values_fill=list(ones=0),names_prefix = "A6_")  %>%  #indicators for roommates  
  select(grep("^G2|^G3|^G4|^G8|^G9|^G10|^G15|^G14|^G11|^G12|^G13|^A5|^A6",colnames(.)))

```


```{r}
myModelG <- ' # regressions
  DRINKCAT ~ Back + Fam + HS + Live
  # latent variable definitions
  Back =~ G2 + 
    G3_1 + G3_2 + G3_3 + G3_4 + G3_5 + 
    G4_1 + G4_2 + G4_3 + G4_4 + G4_5 + G4_6
  Fam =~ G14 + G14_NA + G14_none +
    G15 + G15_none + G15_NA +
    G11 + G11_NA + G11_none +
    G12 + G12_NA + G12_none +
    G13 + G13_none
  HS =~ G8 + G9 + G10
  Live =~ A5_1 + A5_2 + A5_3 + A5_4 + A5_5 + A5_6 +
    A6_1 + A6_2 + A6_3 + A6_4 + A6_5 + A6_6
  # variances and covariances
  Fam ~~ HS
  Fam ~~ Back
  # intercepts
  HS ~ 1
'
```


```{r}
DRINKCAT<-cas93$DRINKCAT
drinkcat<-cbind(MICEd_impute,DRINKCAT) %>% drop_na()
cfa(myModel,drinkcat)
```


Data for 1997

```{r}
#background (need to make indicators for G3,G4)
Back<-G2+G3+G4
#May need to make one indicator for G16 (Family opinion on alc), G14-15 (the idk or not applicable options)
Fam<-G14+G15+G16+G17
#HS
HS<-G9+G10+G11

```


