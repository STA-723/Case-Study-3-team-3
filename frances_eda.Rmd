---
title: "R Notebook"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(caret)
library(randomForest)
library(rebus)
library(mice)
library(glmnet)
```


```{r cars}
cas93<-readRDS("cas93.rds")
cas93 %>% mutate_at(vars(starts_with("B1_")),funs(factor)) %>% select(starts_with("B1_")) %>% count(B1_E)
```

We first look at missing data in section C:
\begin{enumerate}
  \item If the student hasn't had >5 drinks in a row for the past two weeks, they skip C2 and C3
  \item C6: If the student is alcohol abstinent, then they skip C7-C21. If the student hasn't drank in the past year, they skip C7-C18. If the student hasn't drank in the past month, they skip C7-C11.
  \item C11: Students skip this question if they are 21 years or older
  \item C22: Students skip this question if they have not had alcohol within the past year.
\end{enumerate}


```{r}
#all columns to character columns
cas93_C<-cas93[,grepl("^C[0-9]",colnames(cas93))]

abs<-"C[7-9]|C1[0-9]|C2[0-1]"
year<-"C[7-9]|C1[0-8]"
month<-"C[7-9]|C1[0-1]"

cas93_filled<-cas93_C %>% 
  mutate_at(vars( starts_with("C2_") ), 
          list( ~replace_na(.,0) ))  %>%
  mutate_at(vars( starts_with("C3_") ), 
          list( ~replace_na(.,0) ))

#imputing infrequent drinking for skipped questions C7-C21
abs_imp<-cas93_filled[,grep(abs,colnames(cas93_filled))]
abs_imp[rowSums(is.na(abs_imp))== ncol(abs_imp),]<-0

year_imp<-abs_imp[,grep(year,colnames(abs_imp))]
abs_imp[rowSums(is.na(year_imp))== ncol(year_imp),grep(year,colnames(abs_imp))]<-0

month_imp<-abs_imp[,grep(month,colnames(year_imp))]
abs_imp[rowSums(is.na(month_imp)) == ncol(month_imp),grep(month,colnames(year_imp))]<-0

#imputing older students for C11; still need to cross check with age group variable

q_c11<-abs_imp %>% select(starts_with("C11_"))
abs_imp[rowSums(is.na(q_c11)) == ncol(q_c11),grep("C11_",colnames(abs_imp))]<-0

#imputing students who didn't drink in the last year for C22; might have to take this with a grain of salt

q_c22<-cas93_filled %>% select(starts_with("C22_"))
cas93_filled[rowSums(is.na(q_c22)) == ncol(q_c22),grep("C22_",colnames(cas93_filled))]<-0


#Up to C7, up from C7:C10, C11, C12:C21, C22, rest
cas93_filled<-cbind(cas93_filled[1:10],abs_imp[1:69],cas93_filled[80:93])

#original data frame with imputed C
cas93_w_final_c<-cbind(cas93[,!grepl("^C[0-9]",colnames(cas93))],cas93_filled) %>%
  select(-COLL_ID,-STUDY_ID,-A1)

cas93_survey_only<-cas93_w_final_c[,grep("^[A-Z][1-9]",colnames(cas93_w_final_c))] 
```

We impute the rest of the missing values with MICE:

```{r}
mice_data<-mice(cas93_filled,m=4)
MICEd_impute_C<-complete(mice_data,1)
```


```{r C-G,eval=FALSE}

#all columns to character columns
cas93_C<-cas93[,grepl("^C[0-9]",colnames(cas93))] %>%
  cbind(cas93$AGEGROUP) %>%
  mutate_each(as.character())

abs<-"C[7-9]|C1[0-9]|C2[0-1]"
year<-"C[7-9]|C1[0-8]"
month<-"C[7-9]|C1[0-1]"

cas93_filled<-cas93_C %>% 
  mutate_at(vars( starts_with("C2_") ), 
          list( ~replace_na(.,"<5") ))  %>%
  mutate_at(vars( starts_with("C3_") ), 
          list( ~replace_na(.,"<5") ))

#imputing infrequent drinking for skipped questions C7-C21
abs_imp<-cas93_filled[,grep(abs,colnames(cas93_filled))]
abs_imp[rowSums(is.na(abs_imp))== ncol(abs_imp),]<-"abs"

year_imp<-abs_imp[,grep(year,colnames(abs_imp))]
abs_imp[rowSums(is.na(year_imp))== ncol(year_imp),grep(year,colnames(abs_imp))]<-">year"

month_imp<-abs_imp[,grep(month,colnames(year_imp))]
abs_imp[rowSums(is.na(month_imp)) == ncol(month_imp),grep(month,colnames(year_imp))]<-">month"

#imputing older students for C11; still need to cross check with age group variable

q_c11<-abs_imp %>% select(starts_with("C11_"))
abs_imp[rowSums(is.na(q_c11)) == ncol(q_c11),grep("C11_",colnames(abs_imp))]<-">21"

#imputing students who didn't drink in the last year for C22; might have to take this with a grain of salt

q_c22<-cas93_filled %>% select(starts_with("C22_"))
cas93_filled[rowSums(is.na(q_c22)) == ncol(q_c22),grep("C22_",colnames(cas93_filled))]<-">year"


#Up to C7, up from C7:C10, C11, C12:C21, C22, rest
cas93_filled<-cbind(cas93_filled[1:10],abs_imp[1:69],cas93_filled[80:93])

#original data frame with imputed C
cas93_w_final_c<-cbind(cas93[,!grepl("^C[0-9]",colnames(cas93))],cas93_filled)  %>%
  mutate_if(sapply(., is.character), as.factor) %>%
  mutate_if(sapply(., is.numeric), as.factor) %>%
  select(-COLL_ID,-STUDY_ID,-A1)

cas93_survey_only<-cas93_w_final_c[,grep("^[A-Z][1-9]",colnames(cas93_w_final_c))] 

```


We now look at section G: there doesn't seem to be any obvious pattern to the missingness.

```{r}
#all columns to character columns
cas93_G<-cas93[,grepl("G[0-9]",colnames(cas93))] 
```


