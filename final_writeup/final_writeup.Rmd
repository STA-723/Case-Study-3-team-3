---
title: "Understanding the Relationship Between College Drinking Behavior and Sexual Assault in 1997"
author: "Phuc Nguyen, Ezinne Nwankwo, Frances Hung"
date: "2/19/2020"
output:
  pdf_document: default
  html_document: default
bibliography: bibliography.bib
link-citations: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,eval=FALSE)
suppressMessages(library(kableExtra))
suppressMessages(library("tidyverse"))
library(tidyverse)
library(glmnet)
library(lavaan)
```

\begin{abstract}

In this paper, we study the factors that influence college drinking behavior and its effects on other harmful behaviors, in particular sexual assault. We answer three main questions of interest: understanding student-specific factors that influence college drinking behavior, determining if current school policies and alcohol eduction have any influence on college drinking, and understanding the relationship between college drinking behavior and sexual assault while accounting for other confounding factors (i.e. family drinking behaviour). Through the use of mediation analysis and structural equation models, we are able to isolate the direct effect of other factors on sexual assault and their indirect effect through college drinking behavior. We conclude that in 1997, high school drinking behavior had the largest effects, both directly and indirectly, on college drinking behavior and on incidences of sexual assault. 

\end{abstract}


## Introduction

Drinking in college is akin to a rite of passage; while policies around college campus seem to vary in terms of strictness, enforcement is often less stringent than at bars and clubs. Rather than focusing on drinking, many schools care more about the dangerous situations that drinking can lead to, like sexual assault and drunk driving. For this study, we focus on understanding sexual assault, as it is a pervasive and pertinent issue on college campuses. We are interested in studying three questions in the hopes that we can help colleges take preventative measures: (i.) which factors influence college drinking behavior (ii.) how school policies influence drinking behavior and (iii.) how those behaviors can lead to sexual assault. Our data comes from the 1997 Havard School of Public Health College Alcohol Study, a survey of students from more than 100 colleges across the US which sought to collect information on drinking habits, school policy, and personal activities/beliefs [@Wechsler].

## Materials and Methods

We use Structural Equation Modeling (SEM) for modeling relationships between information collected via the survey and our dependent variables `drinkcat` and `sexassault_ind`. SEM is a way of implementing dimension reduction (by using latent factors) while retaining coarse information on all variables of interest. This is different from other dimension reduction strategies which get rid of some variables outright [@Hox]. The SEM package we use in R, `lavaan`, uses partial least squares regression to find a linear model relating the independent and dependent variables through latent factors [@Rosseel]. We standardize all of the variables we use in order to make our coefficients interpretable and comparable in the final model.

We create the following latent factors from existing survey question variables (Fig. \ref{fig:latent-vars}). Since these factors must be correlated, interpretable, and continuous (due to our use of the `lavaan` package), we ensure that the survey question variables included in each factor are uniformly ordinal in an interpretable way. Our two factors related to students' pre-college lives are Family Education/Drinking (G14-17) and High School Drinking Behavior (G9-11). The external-policy related factors are College Alcohol Policy (B1, B2, B9), College Alcohol Education (B7, B8), and City Alcohol Policy (B11-13). The rest of the latent factors have to do with students' college experiences and opinions: Academic Wellbeing (F1, F4), Personal Wellbeing (F6's), Support for Stricter Policies (D3's), Opinions on the Number of Appropriate Drinks (D1's), Time Spent on Activities (F5's), and General Interests for College Experience (split into activities involving and not involving partying/Greek life, A10's). All of the latent factors which draw from one survey question actually consist of several sub-questions within each question (i.e. D3's consist of student rankings of agreement with many different school policies). We fit an ordered logistic regression to model the relationships between these latent factors and `drinkcat`. The graphical model is represented in Fig. \ref{fig:path-sem}.

In order to understand the relationships between drinking behaviors and sexual assault, we fit another latent factor model with mediation on the indicator of being a victim of sexual assault given family education/drinking background, high school drinking, `drinkcat`, and participation in parties. Mediation analysis allows us to estimate how much of the association between a risk factor, such as participation in parties, and the risk of sexual assault is mediated by the victim's drinking behavior [@MacKinnon]. We model the relationships for two outcomes: sexual assault incidents when the victim was drinking and when the assaulter was drinking. The equations for the mediation model are written below (also see Fig. \ref{fig:path-med}): 

$$
\begin{aligned}
\text{drinkcat} &\sim \text{communities} + \text{family} + \text{highschool} \\
\text{sexualassault} &\sim \text{communities} + \text{family} + \text{highschool} + \text{drinkcat}
\end{aligned}
$$

## Results

### Data Cleaning

Due to the structure of the survey (students skip certain questions based on their answers), there are a lot of missing values induced in the data for certain variables. We impute zero values for NAs if the variables are ordinal and if NAs are naturally lowest in the ordinal structure. Otherwise, we create indicator variables for whether a person answered NA or not for each variable in question. We additionally drop true missing values.

### Exploratory Data Analysis

For our dependent variable measuring drinking behavior, we choose to use `drinkcat`, a variable created by researchers which classifies drinking behavior into four ordinal risk categories, where `drinkcat = 2` and `drinkcat = 3` are categorized as binge drinkers. The sexual assault index variable draws from three questions in the survey related to occurences of sexual assault when alcohol is involved: D5_H (unwanted sexual advance, intoxicated perpetrator), D5_I (date rape/sexual assault, intoxicated perpetrator), E15 (intoxicated, unable to consent). If any one of these questions is marked as occuring at least once by the respondent, then the sexual assault variable is equal to one and is zero otherwise.

### Main Results

Table \ref{tab:full-coefs} shows the estimates and 95\% confidence intervals for the coefficents of latent variables in the drinking behavior model. We accept the model as its RMSEA 95\% CI of [0.053, 0.054] is around the conventional threshold for a good fit [@Hox]. Since the survey answers generally do not have physical units, we standardize the variables to compare the size of the estimated coefficients. The dependent variable, i.e. the rating of levels of drinking, also does not have physical units. Thus, we will interpret these coefficents in terms of the relative magnitude and direction of their associations with more binge drinking. High school drinking history is most correlated with more drinking in college. The latent factor Parties summarizing the importance of fraternity/sorority, parties and athletics to students, with a lower value corresponding to more importance, has the second largest association. In other words, students who are more involved in these groups tend to drink more. The latent factor Communities measures the importance of other activities such as volunteering, religion, arts, activism and academic, has the third largest association. Students who care less about these activities tend to drink more. Fourthly, students who perceive a larger number of drinks as appropriate tend to drink more. The loadings of these four latent variables are shown in Table \ref{tab:load-coefs}. Other latent variables with significant but smaller associations with more drinking in college include Personal Wellbeing, Family Education/Drinking and Support for More Lenient Policy. That is, students who are generally more happy, whose families approve of drinking, or who support more lenient drinking policies on campus tend to drink more. There is not enough evidence to establish a relationship between stricter college drinking policy and drinking behaviors. We find a small association between more exposure to alcohol/drinking education and heavier drinkers. We hypothesize that students who already have drinking problems or schools with more prevalent drinking culture might consequently have more educational programs on the issue.

We accept both of the mediation models for when the victim was drinking and when the assaulter was drinking (RMSEA 95\% CI's of [0.029, 0.035] and [0.029, 0.034] respectively). More acceptance of alcohol use from family, drinking history in high school, more participation in parties/Greek life/athletics and more binge drinking are all significantly associated with higher risk of sexual assault in both models, as seen in Table \ref{tab:medvictim-coefs} and Table \ref{tab:medass-coefs}. Table \ref{tab:indir-coefs} and \ref{tab:indir2-coefs} show that the indirect effects of family, high school drinking history and parties, mediated through a student's drinking behavior, are statistically signficant at 5\% level. Interestingly, the indirect effects are larger when the victims were drinking compared to when the assaulters were drinking at the time of the incidents.

### Sensitivity Analysis

We can compare our SEM model for college drinking severity to an elastic net model created using the $\texttt{glmnet}$ package. Both of these models carry out dimension reduction using different methods, so it is interesting and reassuring to note that the results of both seem to corraborate one another. From the elastic net model, the most important predictors for heavy drinkers are A10_F(parties, -), B6_D (times they were part of drinking group which was asked to be quieter/less disruptive, +), D1_B (opinion on appropriate amount for off-campus bar drinking, +), D9_B (percentage of friends who are binge drinkers, +), and G11 (HS number of binges, +). This supports the results of our latent factor model, which finds strong correlations of college drinking with drinking attitudes, emphasis on partying, and high school drinking. 

## Discussion and Future Work 

Using data from Harvard's survey on college drinking behavior, we model factors associated with heavy drinking behaviors and the risk of sexual assault. We find that high school drinking history is most correlated with more drinking in college. Importance of parties/Greek-life/athletics, little involvement in other communal activities, and permissive attitude on the amount of alcohol generally appropriate to consume are also highly correlated with heavier drinking. These results align with current knowledge of patterns of alcohol use. As for our seecond question on the relationship between college alcohol policies and drinking behaviors, we found no evidence of a relationship between strictness of college or city drinking policies and drinking behaviors. We also saw that schools that had less educational material on the effects of drinking were associated with less drinking among students. This result is counterintuitive but we believe that this may be due to the fact that colleges with more educational material are more likely to have high levels of drinking already on their campuses. Universities are creating the educational material to combat drinking problems that already exist on their campuses. Finally, when in came to studying sexual assault activity, we found that high school drinking habits alone and through mediator contributes the most to incidences of sexual assault. Other risk factors for sexual assault are also mediated by the victim's drinking habits. The mediated effect is larger if the victim was drinking when the incident occurred. We assume linearity and normality in our models, so in the future we want to extend to non-parametric models with SEM 

\newpage

## Appendix

```{r num-drinks-eda, echo=FALSE, eval=TRUE,out.width = "300px", fig.align="center", fig.pos = "h", fig.cap="\\label{fig:num-drinks-eda}The figure shows the number of students attending certain events, faceted by number of drinks had at an event."}
knitr::include_graphics("plots/num_drink_plot.png")
```


```{r reasons-eda, echo=FALSE, eval=TRUE,out.width = "500px", fig.align="center", fig.cap="\\label{fig:latent-vars}The figure shows the reasons why students say they drink, faceted by importance (very important=1)."}
knitr::include_graphics("plots/reasons_plot.png")
```


```{r latent-vars, echo=FALSE, eval=TRUE,out.width = "300px", fig.align="center",fig.pos="h", fig.cap="\\label{fig:latent-vars}Figure shows latent factors (ovals) in the SEM for drinking behaviors. Squares show summary of actual questions in the survey."}
knitr::include_graphics("plots/latent_vars.png")
```


```{r, echo=FALSE, eval=TRUE,out.width = "300px", fig.align="center",fig.pos="h", fig.cap="\\label{fig:path-sem}Figure shows path diagram of SEM on risk factors for heavy drinking behaviors in college."}
knitr::include_graphics("plots/latent_variable_model.png")
```

```{r, echo=FALSE, eval=TRUE,out.width = "300px", fig.align="center",fig.pos="h", fig.cap="\\label{fig:path-med}Figure shows path diagram of mediation model for the indirect effects of family, high school drinking behaviors and parties on risk of sexual assault."}
knitr::include_graphics("plots/mediation_analysis.png")
```


```{r loading_table, eval=TRUE, echo=FALSE}
suppressMessages(library(xtable))
full_coefs <- readRDS("table/full_estimates.rds")
```

\newpage

```{r, eval=TRUE, echo=FALSE, results='asis', fig.align = "center",fig.pos="h"}
knitr::kable(full_coefs %>% 
               filter(op == "~") %>%
               mutate(latent_var = rhs, est = round(est, 2), p_value = round(pvalue, 2),
                      ci_lower = round(ci.lower, 2), ci_upper = round(ci.upper, 2)) %>%
               select(latent_var, est, ci_lower, ci_upper, p_value),
             align = "c",
             caption = "\\label{tab:full-coefs}Estimates and 95 percent confident intervals of latent factors in the SEM for levels of drinking. High school drinking, support of more lenient drinking policy, importance of parties (parties), less exposure to alcohol education, family drinks, and personal wellbeing are associated with more drinking in college")
```


```{r, eval=TRUE, echo=FALSE, results='asis', fig.align="center", fig.pos="h"}
knitr::kable(full_coefs %>% 
               filter(op == "=~" & lhs %in% c("highschool_drink", "parties", "communities", "attitude_drink")) %>%
               mutate(latent_var = lhs, survey_question = rhs, est = round(est, 2), p_value = round(pvalue, 2),
                      ci_lower = round(ci.lower, 2), ci_upper = round(ci.upper, 2)) %>%
               select(latent_var, survey_question, est, ci_lower, ci_upper, p_value),
             align = "c",
             caption = "\\label{tab:load-coefs}Loadings of survey questions for latent factors.")
```

```{r, results='asis', eval=TRUE, echo=FALSE, fig.align = "center",fig.pos="h"}
medvictim_coef <- readRDS("table/med_them_estimates.rds")
knitr::kable(medvictim_coef %>% 
               filter(op == ":=") %>%
               separate(label, c("type", "vars")) %>%
               mutate(effect_type = type, latent_var = vars, est = round(est, 2), p_value = round(pvalue, 2),
                      ci_lower = round(ci.lower, 2), ci_upper = round(ci.upper, 2)) %>%
               select(latent_var, effect_type, est, ci_lower, ci_upper, p_value),
             align = "c",
             caption = "\\label{tab:medvictim-coefs}Direct and indirect effects of latent factors on risk of sexual assault when victim was drinking.")
```

```{r, eval=TRUE, echo=FALSE, results='asis', fig.align = "center", fig.pos="h"}
medass_coef <- readRDS("table/med_others_estimates.rds")
knitr::kable(medass_coef %>% 
               filter(op == ":=") %>%
               separate(label, c("type", "vars")) %>%
               mutate(effect_type = type, latent_var = vars, est = round(est, 2), p_value = round(pvalue, 2),
                      ci_lower = round(ci.lower, 2), ci_upper = round(ci.upper, 2)) %>%
               select(latent_var, effect_type, est, ci_lower, ci_upper, p_value),
             align = "c", 
             caption = "\\label{tab:medass-coefs}Direct and indirect effects of latent factors on risk of sexual assault when assaulter was drinking.")
```

\newpage

Below are tables of the estimates for the following three models
$$
\begin{aligned}
\text{SEXASSAULT} &\sim \text{communities} + \text{family$\_$drink} + \text{highschool$\_$drink} \\
\text{DRINKCAT} &\sim \text{communities} + \text{family$\_$drink} + \text{highschool$\_$drink} \\
\text{SEXASSAULT} &\sim \text{DRINKCAT}
\end{aligned}
$$

```{r, results='asis', eval=TRUE, echo=FALSE, fig.pos="h"}
knitr::kable(medass_coef %>% 
               head(7) %>%
               mutate(response = recode(lhs, "SEXASSAULT_others" = "SEXASSAULT"), 
                      latent_var = rhs, 
                      est = round(est, 2), p_value = round(pvalue, 2),
                      ci_lower = round(ci.lower, 2), ci_upper = round(ci.upper, 2)) %>%
               select(response, latent_var, est, ci_lower, ci_upper, p_value),
             align = "c",
             caption = "\\label{tab:indir2-coefs}Coefficient estimates of the three models. The response is indicator of sexual assault when the assaulter was drinking.")
```



```{r, results='asis', eval=TRUE, echo=FALSE, fig.pos="h"}
knitr::kable(medvictim_coef %>% 
               head(7) %>%
               mutate(response = recode(lhs, "SEXASSAULT_them" = "SEXASSAULT"), 
                      latent_var = rhs, 
                      est = round(est, 2), p_value = round(pvalue, 2),
                      ci_lower = round(ci.lower, 2), ci_upper = round(ci.upper, 2)) %>%
               select(response, latent_var, est, ci_lower, ci_upper, p_value),
             align = "c",
             caption = "\\label{tab:indir-coefs}Coefficient estimates of the three models. The response is indicator of sexual assault when the victim was drinking.")
```

```{r load_data, include = FALSE, cache=TRUE}
### Reading In Data
### Split file by number of columns for each variable in Record_layout.txt file. Spaces are missing values.
read_cas <- function(folder, file, recordfile) {
  skip <- grep("--------", readLines(unz(folder, recordfile)))
  record_layout <- read.table(unz(folder, recordfile), 
                            fill = TRUE, skip = skip, header = FALSE)
  colnames(record_layout) <- c("variable_name", "start_col", "end_col", "type")
  record_layout <- record_layout %>% filter(!is.na(end_col))
  widths <- as.numeric(as.character(record_layout$end_col)) - as.numeric(as.character(record_layout$start_col)) + 1
  cas <- read.fwf(unz(folder, file), widths = widths, header	= FALSE,
                  col.names = record_layout$variable_name)
  return(cas)
}
cas97 <- read_cas(folder = "Harvard_CAS_1997.zip", 
                  file = "Harvard_CAS_1997/DS0001/03163-0001-Data.txt",
                  recordfile = "Harvard_CAS_1997/DS0001/03163-0001-Record_layout.txt")
```


```{r summary_na_function, include = FALSE}
summary_na<-function(df) {
  na_count <- colSums(apply(df, 2, is.na))
  data.frame(name = colnames(df), na_pct = na_count/nrow(df)) %>% arrange(desc(na_pct))
}
```



```{r section_a, include = FALSE}
#### Section A
# See which vars have lots of NA's
# The survey asks students to skip some questions on purpose. We manually go through the survey to impute these values and drop remaining missing entries.
cas97 %>% 
  dplyr::select(which(grepl("^A", colnames(.)))) %>%
  summary_na()

# Fill in NA's that mean 0
cas97 <- cas97 %>%
  mutate(A8_answered = cas97 %>%
                        dplyr::select(which(grepl("^A8_", colnames(.)))) %>%
                        rowSums(na.rm = TRUE)) %>%
  mutate(A8_1 = ifelse(is.na(A8_1) & A8_answered > 0, 0, A8_1),
         A8_2 = ifelse(is.na(A8_2) & A8_answered > 0, 0, A8_2),
         A8_3 = ifelse(is.na(A8_3) & A8_answered > 0, 0, A8_3),
         A8_4 = ifelse(is.na(A8_4) & A8_answered > 0, 0, A8_4)) %>%
  # A6 should be dummified
  mutate(ones = 1) %>%
  tidyr::pivot_wider(names_from = A6, 
                     values_from = ones, 
                     values_fill = list(ones = 0), 
                     names_prefix = "A6_") %>%
  # Some NA in A7 means student lived off campus
  mutate(A7 = ifelse(is.na(A7) & A6_5 == 1, 0, A7)) %>%
  # Drop A4, A5 that are transfer questions, otherwise have to dummify
  dplyr::select(-A4, -A5, -A8_answered, -A8)

# How many complete cases left?
cas97 %>%
  dplyr::select(which(grepl("^A", colnames(.)))) %>%
  filter(complete.cases(.)) %>%
  nrow()
```




```{r section_b, include = FALSE}
#### Section B

#No skipped questions

#For B10, an indicator is an option, fill in zero for than NA
# Which columns in this section have lots of NA?
cas97 %>% 
  dplyr::select(which(grepl("^B", colnames(.)))) %>%
  summary_na()

# Fill in NA that actually means 0
cas97 <- cas97 %>%
  mutate(B10_answered = cas97 %>%
                        dplyr::select(which(grepl("^B10_", colnames(.)))) %>%
                        rowSums(na.rm = TRUE)) %>%
  mutate(B10_1 = ifelse(is.na(B10_1) & B10_answered > 0, 0, B10_1),
         B10_2 = ifelse(is.na(B10_2) & B10_answered > 0, 0, B10_2),
         B10_3 = ifelse(is.na(B10_3) & B10_answered > 0, 0, B10_3),
         B10_4 = ifelse(is.na(B10_4) & B10_answered > 0, 0, B10_4),
         B10_5 = ifelse(is.na(B10_5) & B10_answered > 0, 0, B10_5),
         B10_6 = ifelse(is.na(B10_6) & B10_answered > 0, 0, B10_6),
         B10_7 = ifelse(is.na(B10_7) & B10_answered > 0, 0, B10_7),
         B10_8 = ifelse(is.na(B10_8) & B10_answered > 0, 0, B10_8)) %>%
  dplyr::select(-B10_answered)

# How many complete cases left?
cas97 %>%
  dplyr::select(which(grepl("^B", colnames(.)))) %>%
  filter(complete.cases(.)) %>%
  nrow()
```


```{r section_d, include = FALSE}
#### Section D
# Which columns in this section have lots of NA?
cas97 %>% 
  dplyr::select(which(grepl("^D\\d", colnames(.)))) %>%
  summary_na()

cas97 <- cas97 %>%
  dplyr::select(-D7_1, -D7_2, -D7_3, -D7_4)

# How many complete cases left?
cas97 %>%
  dplyr::select(which(grepl("^D\\d", colnames(.)))) %>%
  filter(complete.cases(.)) %>%
  nrow()
```


```{r section_e, include = FALSE}
#### Section E

#Possible groups to consider: Female vs Male, Younger vs Older than 21 years old
# Which columns in this section have lots of NA?
cas97 %>% 
  dplyr::select(which(grepl("^E\\d", colnames(.)))) %>%
  summary_na()

cas97 <- cas97 %>%
  # Fill NA resulted from dummifying vars E23
  mutate(E23_answered = cas97 %>%
                        dplyr::select(which(grepl("^E23_", colnames(.)))) %>%
                        rowSums(na.rm = TRUE)) %>%
  mutate(E23_1 = ifelse(is.na(E23_1) & E23_answered > 0, 0, E23_1),
         E23_2 = ifelse(is.na(E23_2) & E23_answered > 0, 0, E23_2),
         E23_3 = ifelse(is.na(E23_3) & E23_answered > 0, 0, E23_3)) %>%
  # Fill E27 with 0 for people less than 21 years old
  mutate(E27_A = ifelse(is.na(E27_A) & AGELT21 == 1, 0, E27_A)) %>%
  dplyr::select(-E27_B, -E27_C) %>%
  # Combine E24, 25, 26: Did you get seriously injured within 6 hours of drinking: fill 0 in NA E25
  replace_na(list(E25 = 0)) %>%
  # E10-12 skipped if never had sex. Can combine E9 and E11, drop E10, E12
  mutate(E9n11 = ifelse(is.na(E11) & E9 == 1, 0, E11 + 1)) %>%
  dplyr::select(-E9, -E10, -E12, -E11) %>%
  # E13-15 skipped if male
  replace_na(list(E13 = 0, E14 = 0, E15 = 0)) %>%
    #mutate(sex_assualt = ifelse(D4_H > 1 | D4_I > 1 | E15 > 1,max(D4_H,D4_I,E15, na.rm = TRUE), 1))
  dplyr::select(-E24, -E26, -E23_answered, -E23) %>%
  #create sexual assault due to drinking variable
  mutate(sex_assualt_ind = ifelse(D4_H > 1 | D4_I > 1 | E15 > 0, 1, 0))

```



```{r section_f, include = FALSE}
#### Section F
# Which columns in this section have lots of NA?
cas97 %>% 
  dplyr::select(which(grepl("^F", colnames(.)))) %>%
  summary_na()

# Remove F70/30FRND
cas97 <- cas97 %>%
  dplyr::select(-F70FRND, -F30FRND)
```



```{r section_g, include = FALSE}
#### Section G
cas97 <- cas97 %>% 
  mutate(G3_answered = cas97 %>%
                        dplyr::select(which(grepl("^G3_", colnames(.)))) %>%
                        rowSums(na.rm = TRUE)) %>%
  mutate(G3_1 = ifelse(is.na(G3_1) & G3_answered > 0, 0, G3_1),
         G3_2 = ifelse(is.na(G3_2) & G3_answered > 0, 0, G3_2),
         G3_3 = ifelse(is.na(G3_3) & G3_answered > 0, 0, G3_3),
         G3_4 = ifelse(is.na(G3_4) & G3_answered > 0, 0, G3_4),
         G3_5 = ifelse(is.na(G3_5) & G3_answered > 0, 0, G3_5),
         ) %>%
  dplyr::select(-G3_answered, -G3) %>%
  mutate(ones=1) %>%
  pivot_wider(names_from = G4,
              values_from = ones,
              values_fill = list(ones=0),
              names_prefix = "G4_") %>%  #indicators for religion
  mutate(G14_NA = as.numeric(G14==5),
         G14_none = as.numeric(G14==6),
         G15_NA = as.numeric(G15==5),
         G15_none = as.numeric(G15==6)) %>% #indicators for don't know/NA, parental drinking
  #indicator for no family agreement about drinking
  mutate(G16_none=as.numeric(G16==4)) %>%
  # Change "I don't know" into 0
  mutate(G14 = ifelse(G14 == 8, 0, G14),
         G15 = ifelse(G14 == 8, 0, G15),
         G16 = ifelse(G16 == 1, 0, G16),
         G16 = ifelse(G16 == 4, 1, G16)
         )
# Which columns in this section have lots of NA?
cas97 %>% 
  dplyr::select(which(grepl("^G\\d", colnames(.)))) %>%
  summary_na()
```


```{r check_complete_case, include = FALSE}
#Here we check for the number of complete cases after the preprocessing step above:
cas97 %>%
  dplyr::select(which(grepl("^[[:upper:]]\\d", colnames(.)))) %>%
  dplyr::select(which(!grepl("^C\\d", colnames(.)))) %>% # Remove Section C for now
  filter(complete.cases(.)) %>%
  dim()
```



```{r drinkcat_missingness, include = FALSE}

#We only have about 7100 observations for 212 variables 
#There are few missing values for the response DRINKCAT

mean(is.na(cas97$DRINKCAT))

```

```{r corr matrix, include = FALSE, eval = FALSE}

#### Multicolinearity
cas97_noc <- cas97 %>%
  dplyr::select(which(grepl("^[[:upper:]]\\d", colnames(.)))) %>%
  dplyr::select(which(!grepl("^C\\d", colnames(.)))) %>% # Remove Section C for now
  filter(complete.cases(.)) %>%
  dplyr::select(-A6_NA)
#sort(apply(cas97_noc, 2 , sd))
#Drop A6_NA in complete cases, because the standard deviation is 0 and we also check the correlation between the variables
plot_cormat <- function(X) {
  cormat <- round(cor(X), 2)
  melted_cormat <- reshape2::melt(cormat)
  ggplot(data = melted_cormat, aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile() + scale_fill_gradient2(low = "blue", mid = "white", high = "red")
  ggsave("plots/corr_matrix.png")
}

plot_cormat(cas97_noc)
```

```{r corr_matrix_output, echo = FALSE, eval = TRUE, fig.pos = "h",out.width = "300px", fig.align="center", fig.cap="\\label{fig:corr_matrix} Correlations between Survey Questions."}
knitr::include_graphics("plots/corr_matrix.png")

```


```{r corr dist, echo = FALSE, fig.cap="Histogram of Correlations"}
cormat <- round(cor(cas97_noc), 2)
covvec <- cormat[upper.tri(cormat, diag = FALSE)]
hist(covvec, breaks = 50)
#reshape2::melt(cormat) %>%
#  filter(Var1 != Var2) %>%
#  arrange(value)

check_cor <- function(df, desc = FALSE) {
  cormat <- round(cor(df), 2)
  if (desc) {
    reshape2::melt(cormat) %>%
    filter(Var1 != Var2) %>%
    arrange(desc(value))
  } else {
    reshape2::melt(cormat) %>%
    filter(Var1 != Var2) %>%
    arrange(value)
  }
} 
```

\newpage

## Elastic Net Model

```{r}
cas97_glm<-cas97 %>% dplyr::select(grep("^B8_B$|^B8_C$|^B12_A$|^B7_A$|^B7_B$|^B7_C$|^B7_D$|^B7_E$|^B7_F$|^B8_D$|^B12_B$|^B9_C$|^B9_G$|^B1$|^B6_A$|^B6_B$|^B9_A$|^B9_D$|^B9_E$|^B9_F$|^B13_A$|^B13_B$|^B9_B$|^B11$|^B6_E$|^B6_C$|^B13_E$|^B2$|^B3$|^B13_C$|^B13_D$|^B6_D$|^F5_A|^F5_B|^F5_C|^F5_D|^F5_E|^F5_F|^F5_G|^F5_H|^F6_A|^F6_B|^F6_C|^F6_D|^F6_E|^F6_E|^F6_F|^F6_G|^F6_H|^F6_I|^F1|^F4|^F2|^F3|^G2|^G3|^G4|^G9|^G10|^G11|^G15|^G14|^G16|^G17|^G13|^A8|^D2|^D8|^D9|^D3|^D1|^A9|^A10|^DRINKCAT",colnames(.))) %>%
  mutate_all(function(x) scale(as.numeric(x))) %>%
  mutate(DRINKCAT=case_when(DRINKCAT<=1 ~ "light",
                            DRINKCAT<=3 ~ "heavy")) %>%
  mutate(DRINKCAT=as.factor(DRINKCAT)) %>%
  drop_na()

naive_elastic<-cv.glmnet(x=cas97_glm %>%
                         dplyr::select(-DRINKCAT) %>% 
                         mutate_each(as.numeric) %>% 
                         as.matrix(), 
                      y=cas97_glm %>% 
                        dplyr::select(DRINKCAT) %>% 
                        mutate_each(as.factor) %>% 
                        as.matrix(),
                      family="multinomial")

coef(naive_elastic)

#the most important predictors for heavy drinkers: A10_F(parties, neg), B6_D (drinking group which was asked to be quieter/less disruptive, positive), D1_B (opinion on appropriate amount for off-campus bar drinking, pos), D9_B (percentage of friends who are binge drinkers, pos), G11 (HS number of binges, pos)
```

