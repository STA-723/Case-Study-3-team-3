---
title: "Analysis"
author: "Phuc Nguyen, Frances Hung, Ezinne Nwankwo"
date: "2/11/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(caret)
library(randomForest)
library(rebus)
library(mice)
library(glmnet)
library(miceadds)
```

# Data Cleaning

### Load data

Split file by number of columns for each variable in Record_layout.txt file. Spaces are missing values.

```{r load_data, cache=TRUE}
read_cas <- function(folder, file, recordfile) {
  skip <- grep("--------", readLines(unz(folder, recordfile)))
  record_layout <- read.table(unz(folder, recordfile), 
                            fill = TRUE, skip = skip, header = FALSE)
  colnames(record_layout) <- c("variable_name", "start_col", "end_col", "type")
  record_layout <- record_layout %>% filter(!is.na(end_col))
  widths <- as.numeric(as.character(record_layout$end_col)) - as.numeric(as.character(record_layout$start_col)) + 1
  cas <- read.fwf(unz(folder, file), widths = widths, header	= FALSE,
                  col.names = record_layout$variable_name)
  return(cas)
}
cas93 <- read_cas(folder = "Harvard_CAS_1993.zip", 
                  file = "Harvard_CAS_1993/DS0001/06577-0001-Data.txt",
                  recordfile = "Harvard_CAS_1993/DS0001/06577-0001-Record_layout.txt")
cas97 <- read_cas(folder = "Harvard_CAS_1997.zip", 
                  file = "Harvard_CAS_1997/DS0001/03163-0001-Data.txt",
                  recordfile = "Harvard_CAS_1997/DS0001/03163-0001-Record_layout.txt")
cas99 <- read_cas(folder = "Harvard_CAS_1999.zip", 
                  file = "Harvard_CAS_1999/DS0001/03818-0001-Data.txt",
                  recordfile = "Harvard_CAS_1999/DS0001/03818-0001-Record_layout.txt")
cas20 <- read_cas(folder = "Harvard_CAS_2001.zip", 
                  file = "Harvard_CAS_2001/DS0001/04291-0001-Data.txt",
                  recordfile = "Harvard_CAS_2001/DS0001/04291-0001-Record_layout.txt")
```

### Impute missing values

The survey asks students to skip some questions on purpose. We manually go through the survey to impute these values. We use MICE to impute the remaining missing values.

### CAS93

*The below code is for survey in 1993 only*

#### Section B

```{r}
# Section B
# If answer yes to B13, skip B14, B15; If answer no to B14, skip B15.
# We fill in all the skipped rows with 0 ???
cas93 <- cas93 %>% mutate(B14 = ifelse(B13 == 2, 0, B14),
                          B15_A = ifelse(B13 == 2 | B14 == 2, 0, B15_A),
                          B15_B = ifelse(B13 == 2 | B14 == 2, 0, B15_B),
                          B15_C = ifelse(B13 == 2 | B14 == 2, 0, B15_C),
                          B15_D = ifelse(B13 == 2 | B14 == 2, 0, B15_D),
                          B15_E = ifelse(B13 == 2 | B14 == 2, 0, B15_E))
```

#### Section E

```{r}
cas93 <- cas93 %>% 
    mutate(E4 = ifelse(E3 == 2, 0, E4)) %>% 
    mutate(E6 = ifelse(E5== 2, 0, E6)) %>% 
    mutate(E7 = ifelse(E5 == 2, 0, E7)) %>% 
    mutate(E8= ifelse(E5 == 2, 0, E8)) 
```

#### Section C

We first look at missing data in section C:
\begin{enumerate}
  \item If the student hasn't had >5 drinks in a row for the past two weeks, they skip C2 and C3
  \item C6: If the student is alcohol abstinent, then they skip C7-C21. If the student hasn't drank in the past year, they skip C7-C18. If the student hasn't drank in the past month, they skip C7-C11.
  \item C11: Students skip this question if they are 21 years or older
  \item C22: Students skip this question if they have not had alcohol within the past year.
\end{enumerate}


```{r}
#all columns to character columns
cas93_C<-cas93[,grepl("^C[0-9]",colnames(cas93))]

abs<-"C[7-9]|C1[0-9]|C2[0-1]"
year<-"C[7-9]|C1[0-8]"
month<-"C[7-9]|C1[0-1]"

cas93_filled<-cas93_C %>% 
  mutate_at(vars( starts_with("C2_") ), 
          list( ~replace_na(.,0) ))  %>%
  mutate_at(vars( starts_with("C3_") ), 
          list( ~replace_na(.,0) ))

#imputing infrequent drinking for skipped questions C7-C21
abs_imp<-cas93_filled[,grep(abs,colnames(cas93_filled))]
abs_imp[rowSums(is.na(abs_imp))== ncol(abs_imp),]<-0

year_imp<-abs_imp[,grep(year,colnames(abs_imp))]
abs_imp[rowSums(is.na(year_imp))== ncol(year_imp),grep(year,colnames(abs_imp))]<-0

month_imp<-abs_imp[,grep(month,colnames(year_imp))]
abs_imp[rowSums(is.na(month_imp)) == ncol(month_imp),grep(month,colnames(year_imp))]<-0

#imputing older students for C11; still need to cross check with age group variable
q_c11<-abs_imp %>% select(starts_with("C11_"))
abs_imp[rowSums(is.na(q_c11)) == ncol(q_c11),grep("C11_",colnames(abs_imp))]<-0

#imputing students who didn't drink in the last year for C22; might have to take this with a grain of salt
q_c22<-cas93_filled %>% select(starts_with("C22_"))
cas93_filled[rowSums(is.na(q_c22)) == ncol(q_c22),grep("C22_",colnames(cas93_filled))]<-0


#bind with rest of C columns
cas93_C<-cbind(cas93_filled[1:10],abs_imp[1:69],cas93_filled[80:93])

cas93_final<-cas93[,!grepl("^C[0-9]",colnames(cas93))] %>%
  cbind(cas93_C) %>%
  select(-COLL_ID)

```

#### MICE

We impute the rest of the missing values with MICE:

```{r}
#mice_data<-mice(cas93_final,m=4)
#MICEd_cas93<-complete(mice_data,1) %>%
#  .[,grepl("^[A-Z][1-9]",colnames(.))]


#write.mice.imputation(mi.res=mice_data, name="miced_cas93" )

```

```{r}
MICEd_impute_C<-readRDS("MICEd_cas93.rds")
#saveRDS(MICEd_impute_C,file="MICEd_cas93.rds")
multinom_fit<-glmnet(MICEd_impute_C %>% mutate_each(as.numeric) %>% select(-C8) %>% as.matrix(), MICEd_impute_C %>% mutate_each(as.numeric) %>% select(C8) %>% as.matrix(), family="multinomial")
```

### CAS 97

#### Section A

```{r}
# See which vars have lots of NA's
cas97 %>% 
  select(which(grepl("^A", colnames(.)))) %>%
  summary_na()

# Fill in NA's that mean 0
cas97 <- cas97 %>%
  mutate(A8_answered = cas97 %>%
                        select(which(grepl("^A8_", colnames(.)))) %>%
                        rowSums(na.rm = TRUE)) %>%
  mutate(A8_1 = ifelse(is.na(A8_1) & A8_answered > 0, 0, A8_1),
         A8_2 = ifelse(is.na(A8_2) & A8_answered > 0, 0, A8_2),
         A8_3 = ifelse(is.na(A8_3) & A8_answered > 0, 0, A8_3),
         A8_4 = ifelse(is.na(A8_4) & A8_answered > 0, 0, A8_4)) %>%
  # A6 should be dummified
  mutate(ones = 1) %>%
  tidyr::pivot_wider(names_from = A6, 
                     values_from = ones, 
                     values_fill = list(ones = 0), 
                     names_prefix = "A6_") %>%
  # Some NA in A7 means student lived off campus
  mutate(A7 = ifelse(is.na(A7) & A6_5 == 1, 0, A7)) %>%
  # Drop A4, A5 that are transfer questions, otherwise have to dummify
  select(-A4, -A5, -A8_answered)

# How many complete cases left?
cas97 %>%
  select(which(grepl("^A", colnames(.)))) %>%
  filter(complete.cases(.)) %>%
  nrow()
```


#### Section B

No skipped questions

For B10, an indicator is an option, fill in zero for than NA

```{r}
# Which columns in this section have lots of NA?
cas97 %>% 
  select(which(grepl("^B", colnames(.)))) %>%
  summary_na()

# Fill in NA that actually means 0
cas97 <- cas97 %>%
  mutate(B10_answered = cas97 %>%
                        select(which(grepl("^B10_", colnames(.)))) %>%
                        rowSums(na.rm = TRUE)) %>%
  mutate(B10_1 = ifelse(is.na(B10_1) & B10_answered > 0, 0, B10_1),
         B10_2 = ifelse(is.na(B10_2) & B10_answered > 0, 0, B10_2),
         B10_3 = ifelse(is.na(B10_3) & B10_answered > 0, 0, B10_3),
         B10_4 = ifelse(is.na(B10_4) & B10_answered > 0, 0, B10_4),
         B10_5 = ifelse(is.na(B10_5) & B10_answered > 0, 0, B10_5),
         B10_6 = ifelse(is.na(B10_6) & B10_answered > 0, 0, B10_6),
         B10_7 = ifelse(is.na(B10_7) & B10_answered > 0, 0, B10_7),
         B10_8 = ifelse(is.na(B10_8) & B10_answered > 0, 0, B10_8)) %>%
  select(-B10_answered)

# How many complete cases left?
cas97 %>%
  select(which(grepl("^B", colnames(.)))) %>%
  filter(complete.cases(.)) %>%
  nrow()
```

#### Section C

```{r}

```

#### Section D

```{r}
# Which columns in this section have lots of NA?
cas97 %>% 
  select(which(grepl("^D\\d", colnames(.)))) %>%
  summary_na()

cas97 <- cas97 %>%
  select(-D7_1, -D7_2, -D7_3, -D7_4)

# How many complete cases left?
cas97 %>%
  select(which(grepl("^D\\d", colnames(.)))) %>%
  filter(complete.cases(.)) %>%
  nrow()
```


#### Section E

Possible groups to consider: Female vs Male, Younger vs Older than 21 years old

```{r}
# Which columns in this section have lots of NA?
cas97 %>% 
  select(which(grepl("^E\\d", colnames(.)))) %>%
  summary_na()

cas97 <- cas97 %>%
  # Fill NA resulted from dummifying vars E23
  mutate(E23_answered = cas97 %>%
                        select(which(grepl("^E23_", colnames(.)))) %>%
                        rowSums(na.rm = TRUE)) %>%
  mutate(E23_1 = ifelse(is.na(E23_1) & E23_answered > 0, 0, E23_1),
         E23_2 = ifelse(is.na(E23_2) & E23_answered > 0, 0, E23_2),
         E23_3 = ifelse(is.na(E23_3) & E23_answered > 0, 0, E23_3)) %>%
  # Fill E27 with 0 for people less than 21 years old
  mutate(E27_A = ifelse(is.na(E27_A) & AGELT21 == 1, 0, E27_A),
         E27_B = ifelse(is.na(E27_B) & AGELT21 == 1, 0, E27_B),
         E27_C = ifelse(is.na(E27_C) & AGELT21 == 1, 0, E27_C)) %>%
  # Combine E24, 25, 26: Did you get seriously injured within 6 hours of drinking: fill 0 in NA E25
  replace_na(list(E25 = 0)) %>%
  # E10-12 skipped if never had sex TODO: How to resolve this???
  # E13-15 skipped if male
  replace_na(list(E13 = 0, E14 = 0, E15 = 0)) %>%
  # Drop E24, E26, E23_answered
  select(-E24, -E26, -E23_answered)


```

#### Section F

Everything seems fine

```{r}
# Which columns in this section have lots of NA?
cas97 %>% 
  select(which(grepl("^F", colnames(.)))) %>%
  summary_na()

# Remove F70/30FRND
cas97 <- cas97 %>%
  select(-F70FRND, -F30FRND)
```

#### MICE

We impute the rest of the missing values with MICE:

```{r}
#mice_data<-mice(cas93_final,m=4)
#MICEd_cas93<-complete(mice_data,1) %>%
#  .[,grepl("^[A-Z][1-9]",colnames(.))]
#write.mice.imputation(mi.res=mice_data, name="miced_cas93" )
```

```{r}
MICEd_impute_C<-readRDS("MICEd_cas93.rds")
#saveRDS(MICEd_impute_C,file="MICEd_cas93.rds")
multinom_fit<-glmnet(MICEd_impute_C %>% mutate_each(as.numeric) %>% select(-C8) %>% as.matrix(), MICEd_impute_C %>% mutate_each(as.numeric) %>% select(C8) %>% as.matrix(), family="multinomial")
```

### Lavaan Model

#### Section G/Living Situation

1997 UnMICEd data

```{r}
MICEd_impute<-cas97 %>% 
  mutate(ones=1) %>%
  pivot_wider(names_from=G4,values_from=ones, values_fill=list(ones=0),names_prefix = "G4_") %>%  #indicators for religion
  mutate(G14_NA=as.numeric(G14==5),G14_none=as.numeric(G14==6),G15_NA=as.numeric(G15==5),G15_none=as.numeric(G15==6)) %>% #indicators for don't know/NA, parental drinking
  mutate(G16_none=as.numeric(G16==4)) %>% #indicator for no family agreement about drinking
  mutate(ones=1) %>%
  pivot_wider(names_from=A6,values_from=ones, values_fill=list(ones=0),names_prefix = "A6_") %>%  #indicators for housing type
  select(grep("^G2|^G3|^G4|^G8|^G9|^G10|^G15|^G14|^G16|^G17|^G13|^A6|^A8",colnames(.)))
```


```{r}
myModelG <- ' # regressions
  DRINKCAT ~ Back + Fam + HS + Live
  # latent variable definitions
  Back =~ G2 + 
    G3_1 + G3_2 + G3_3 + G3_4 + G3_5 + 
    G4_1 + G4_2 + G4_3 + G4_4 + G4_5 + G4_6
  Fam =~ G14 + G14_NA + G14_none +
    G15 + G15_none + G15_NA +
    G16 + G16_none +
    G17
  HS =~ G8 + G9 + G10
  Live =~ A8_1 + A8_2 + A8_3 + A8_4 +
    A6_1 + A6_2 + A6_3 + A6_4 + A6_5 + A6_6
  # variances and covariances
  Fam ~~ HS
  Fam ~~ Back
  # intercepts
  HS ~ 1
'
```

Right now, this gives output but we need more informative variables. Also, we need to make sure MICE is filling in values in a way which makes sense.

```{r}
DRINKCAT<-cas97$DRINKCAT
drinkcat<-cbind(MICEd_impute,DRINKCAT) %>% drop_na()
cfa(myModelG,drinkcat)
```

