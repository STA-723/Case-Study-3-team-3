---
title: "Analysis"
author: "Phuc Nguyen, Frances Hung, Ezinne Nwankwo"
date: "2/11/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(caret)
library(randomForest)
library(rebus)
library(mice)
library(glmnet)
library(miceadds)
```

# Data Cleaning

### Load data

Split file by number of columns for each variable in Record_layout.txt file. Spaces are missing values.

```{r load_data, cache=TRUE}
read_cas <- function(folder, file, recordfile) {
  skip <- grep("--------", readLines(unz(folder, recordfile)))
  record_layout <- read.table(unz(folder, recordfile), 
                            fill = TRUE, skip = skip, header = FALSE)
  colnames(record_layout) <- c("variable_name", "start_col", "end_col", "type")
  record_layout <- record_layout %>% filter(!is.na(end_col))
  widths <- as.numeric(as.character(record_layout$end_col)) - as.numeric(as.character(record_layout$start_col)) + 1
  cas <- read.fwf(unz(folder, file), widths = widths, header	= FALSE,
                  col.names = record_layout$variable_name)
  return(cas)
}
cas93 <- read_cas(folder = "Harvard_CAS_1993.zip", 
                  file = "Harvard_CAS_1993/DS0001/06577-0001-Data.txt",
                  recordfile = "Harvard_CAS_1993/DS0001/06577-0001-Record_layout.txt")
cas97 <- read_cas(folder = "Harvard_CAS_1997.zip", 
                  file = "Harvard_CAS_1997/DS0001/03163-0001-Data.txt",
                  recordfile = "Harvard_CAS_1997/DS0001/03163-0001-Record_layout.txt")
cas99 <- read_cas(folder = "Harvard_CAS_1999.zip", 
                  file = "Harvard_CAS_1999/DS0001/03818-0001-Data.txt",
                  recordfile = "Harvard_CAS_1999/DS0001/03818-0001-Record_layout.txt")
cas20 <- read_cas(folder = "Harvard_CAS_2001.zip", 
                  file = "Harvard_CAS_2001/DS0001/04291-0001-Data.txt",
                  recordfile = "Harvard_CAS_2001/DS0001/04291-0001-Record_layout.txt")
```

### Impute missing values

The survey asks students to skip some questions on purpose. We manually go through the survey to impute these values. We use MICE to impute the remaining missing values.

*The below code is for survey in 1993 only*

#### Section B

```{r}
# Section B
# If answer yes to B13, skip B14, B15; If answer no to B14, skip B15.
# We fill in all the skipped rows with 0 ???
cas93 <- cas93 %>% mutate(B14 = ifelse(B13 == 2, 0, B14),
                          B15_A = ifelse(B13 == 2 | B14 == 2, 0, B15_A),
                          B15_B = ifelse(B13 == 2 | B14 == 2, 0, B15_B),
                          B15_C = ifelse(B13 == 2 | B14 == 2, 0, B15_C),
                          B15_D = ifelse(B13 == 2 | B14 == 2, 0, B15_D),
                          B15_E = ifelse(B13 == 2 | B14 == 2, 0, B15_E))
```

#### Section E

```{r}
cas93 <- cas93 %>% 
    mutate(E4 = ifelse(E3 == 2, 0, E4)) %>% 
    mutate(E6 = ifelse(E5== 2, 0, E6)) %>% 
    mutate(E7 = ifelse(E5 == 2, 0, E7)) %>% 
    mutate(E8= ifelse(E5 == 2, 0, E8)) 
```



### Section 3

We first look at missing data in section C:
\begin{enumerate}
  \item If the student hasn't had >5 drinks in a row for the past two weeks, they skip C2 and C3
  \item C6: If the student is alcohol abstinent, then they skip C7-C21. If the student hasn't drank in the past year, they skip C7-C18. If the student hasn't drank in the past month, they skip C7-C11.
  \item C11: Students skip this question if they are 21 years or older
  \item C22: Students skip this question if they have not had alcohol within the past year.
\end{enumerate}


```{r}
#all columns to character columns
cas93_C<-cas93[,grepl("^C[0-9]",colnames(cas93))]

abs<-"C[7-9]|C1[0-9]|C2[0-1]"
year<-"C[7-9]|C1[0-8]"
month<-"C[7-9]|C1[0-1]"

cas93_filled<-cas93_C %>% 
  mutate_at(vars( starts_with("C2_") ), 
          list( ~replace_na(.,0) ))  %>%
  mutate_at(vars( starts_with("C3_") ), 
          list( ~replace_na(.,0) ))

#imputing infrequent drinking for skipped questions C7-C21
abs_imp<-cas93_filled[,grep(abs,colnames(cas93_filled))]
abs_imp[rowSums(is.na(abs_imp))== ncol(abs_imp),]<-0

year_imp<-abs_imp[,grep(year,colnames(abs_imp))]
abs_imp[rowSums(is.na(year_imp))== ncol(year_imp),grep(year,colnames(abs_imp))]<-0

month_imp<-abs_imp[,grep(month,colnames(year_imp))]
abs_imp[rowSums(is.na(month_imp)) == ncol(month_imp),grep(month,colnames(year_imp))]<-0

#imputing older students for C11; still need to cross check with age group variable
q_c11<-abs_imp %>% select(starts_with("C11_"))
abs_imp[rowSums(is.na(q_c11)) == ncol(q_c11),grep("C11_",colnames(abs_imp))]<-0

#imputing students who didn't drink in the last year for C22; might have to take this with a grain of salt
q_c22<-cas93_filled %>% select(starts_with("C22_"))
cas93_filled[rowSums(is.na(q_c22)) == ncol(q_c22),grep("C22_",colnames(cas93_filled))]<-0


#bind with rest of C columns
cas93_filled<-cbind(cas93_filled[1:10],abs_imp[1:69],cas93_filled[80:93])

```

#### MICE

We impute the rest of the missing values with MICE:

```{r}
mice_data<-mice(cas93_filled,m=4)
MICEd_impute_C<-complete(mice_data,1)
#write.mice.imputation(mi.res=mice_data, name="mice_C" )

```



